# 这是什么？

这是数据结构课程的PJ2。利用图算法实现了求两个地铁站之间耗时最短的路径。

# 如何使用

点击start.bat以运行程序（不要直接点击jar文件运行）。在左下角的输入框内输入起点车站，中间车站（不是必须的）和终点车站。支持同时计算多个最短路径，不同的路径之间用\n分隔。车站和车站之间以tab分隔。点击开始计算即可，程序很快会输出最短路径（换成时间不记在内），所用的总时间和换乘次数。同时，程序支持从文本文件导入输入和将输出导出到文本文件。

## 例

输入1：

```
人民广场	五角场
```

输出1：

```
人民广场-line8-曲阜路-line12-天潼路-line10-五角场,换乘数2,所用时间18分钟
```

输入2：

```
人民广场	上海南站	嘉善路	新江湾城
```

输出2：

```
人民广场-line1-上海南站-line1-徐家汇-line9-嘉善路-line12-陕西南路-line1-人民广场-line8-曲阜路-line12-天潼路-line10-新江湾城,换乘数6,所用时间64分钟
```

输入3：

```
民雷路	东方绿洲	淀山湖大道	上海赛车场	隆德路	虹口足球场	闵行开发区	浦电路4	宝安公路	大场镇	民生路	民生路	淞发路	春申路	龙柏新村	金海路	顾戴路	浦东大道	刘行	书院
虹口足球场	文井路	镇坪路	国权路	淀山湖大道	上大路	黄兴公园	交通大学	莘庄	文井路	星中路	青浦新城	上海火车站	铁力路	曹路	新闸路	嘉定西	白银路
```

输出3：

```
民雷路-line9-马当路-line13-新天地-line10-虹桥火车站-line17-东方绿洲-line17-淀山湖大道-line17-虹桥火车站-line2-中山公园-line4-曹杨路-line11-上海赛车场-line11-隆德路-line11-曹杨路-line3-虹口足球场-line8-人民广场-line1-莘庄-line5-闵行开发区-line5-莘庄-line1-上海体育馆-line4-浦电路4-line4-上海火车站-line1-宝安公路-line1-上海火车站-line4-镇坪路-line7-大场镇-line7-镇坪路-line4-世纪大道-line6-民生路-line6-民生路-line6-世纪大道-line4-宝山路-line3-淞发路-line3-虹口足球场-line8-人民广场-line1-莘庄-line5-春申路-line5-莘庄-line1-上海体育馆-line4-虹桥路-line10-龙柏新村-line10-老西门-line8-陆家浜路-line9-金海路-line9-世纪大道-line4-上海体育馆-line1-漕宝路-line12-顾戴路-line12-漕宝路-line1-上海体育馆-line4-浦东大道-line4-镇坪路-line7-刘行-line7-镇坪路-line4-世纪大道-line2-龙阳路-line16-书院,换乘数36,所用时间955分钟

江湾镇-line3-虹口足球场-line8-人民广场-line1-陕西南路-line10-虹桥火车站-line17-嘉松中路-line17-虹桥火车站-line10-陕西南路-line1-人民广场-line8-虹口足球场-line3-水产路-line3-宝山路-line4-世纪大道-line2-龙阳路-line16-航头东-line16-龙阳路-line7-高科西路-line6-临沂新村-line6-高科西路-line7-静安寺-line2-江苏路-line11-隆德路-line13-金沙江路-line3-中山公园-line2-虹桥火车站-line17-淀山湖大道-line17-虹桥火车站-line10-陕西南路-line1-人民广场-line2-浦东国际机场-line2-龙阳路-line16-书院-line16-龙阳路-line2-世纪大道-line4-海伦路-line4-大连路-line12-巨峰路-line6-五莲路,换乘数28,所用时间655分钟

虹口足球场-line8-人民广场-line1-莘庄-line5-文井路-line5-莘庄-line1-常熟路-line7-镇坪路-line4-海伦路-line10-国权路-line10-天潼路-line12-曲阜路-line8-人民广场-line1-陕西南路-line10-虹桥火车站-line17-淀山湖大道-line17-虹桥火车站-line2-中山公园-line4-镇坪路-line7-上大路-line7-镇坪路-line4-海伦路-line10-四平路-line8-黄兴公园-line8-四平路-line10-天潼路-line12-曲阜路-line8-人民广场-line1-陕西南路-line10-交通大学-line11-徐家汇-line1-莘庄-line5-文井路-line5-莘庄-line1-上海体育馆-line4-宜山路-line9-星中路-line9-宜山路-line4-虹桥路-line10-虹桥火车站-line17-青浦新城-line17-虹桥火车站-line2-中山公园-line4-上海火车站-line3-铁力路-line3-宝山路-line4-大连路-line12-金海路-line9-曹路-line9-世纪大道-line2-人民广场-line1-新闸路-line1-汉中路-line13-长寿路-line7-镇坪路-line4-曹杨路-line11-嘉定西-line11-白银路,换乘数43,所用时间772分钟
```

## 扩展车站与线路

这个程序支持扩展车站与线路。

station.txt中记载的是所有的车站信息。其中，每一条条目由“车站名+线路名，车站编号”构成。例：人民广场1，12。其中，人民广场是车站名，1是线路名，12是车站编号。

gap.txt中记载的是车站和车站之间的距离（所用时间）。换乘车站之间相互的距离以0.01表示。其中，每一条条目由“车站A的编号,车站B的编号,距离”构成。例如”0，1，2“就表示编号为0的车站（莘庄1）与编号为1的车站（外环路1）之间的距离是两分钟。

要扩展线路和车站，只需要按照上述格式扩展station.txt和gap.txt即可。你也可以按照格式重新定义自己的station.txt和gap.txt（比如构建其他城市的地图线路图），在程序面板中导入。

# 程序设计思路

ps：主要介绍程序核心代码的思路。输入输出和gui界面的实现不再赘述。

## 抽象图的设计

在core.graph下实现了一组抽象图的api。UndirectedWeightedGraph类使用链接表的方法实现了一个无向有权图。图中节点用数字表示。例如有5个节点的图中的节点名为[0,1,2,3,4]。UndirectedWeightedGraph类中使用了dijkstra算法，解决了单源最短路问题。并以GeneralPath[]的形式返回路径的长度和路径本身。

## 有关于地铁的设计

### 存在的类

MetroPath:地铁路径的实例。

MetroStation:地铁站的实例。

MetroTransferProblem:程序的主类。

### 读取数据

读取数据用的是半自动的方法。先将xls的文件转化成csv文件，然后用Scanner来读取。

给每个车站都从0开始编号，每个车站都有其唯一的编号，存储到station.txt中。station.txt中记载的是所有的车站信息。其中，每一条条目由“车站名+线路名，车站编号”构成。例：人民广场1，12。其中，人民广场是车站名，1是线路名，12是车站编号。程序中使用HashMap建立起车站编号与MetroStation的映射关系。

随后记录车站和车站之间的距离（时间），存储到gap.txt中。换乘车站之间相互的距离以0.01表示。其中，每一条条目由“车站A的编号,车站B的编号,距离”构成。例如”0，1，2“就表示编号为0的车站（莘庄1）与编号为1的车站（外环路1）之间的距离是两分钟。

### 程序运行的大致流程（点击”开始计算”后发生了什么）

1.程序读取station.txt，并实例化对应的MetroStation，建立起车站编号（Integer)和车站（MetroStation）的映射numberToStation。

2.程序实例化一个UndirectedWeightedGraph graph。读取gap.txt，将其中每两个车站的距离作为边，加入到graph中。

3.程序读取用户的输入，将用户输入的字符串转化为车站编号，使用graph中的函数求出最短路GeneralPath。

4.步骤3中求出的路是非常抽象的。比如路径是用车站编号表示的（例：0->1->2->3,length=6)。将步骤3求出的GeneralPath，加以numberToStation等信息，具体化成具体的地铁路径。

5.输出。

### 如何解决中转站问题

例如从A->B->C的最短路径，其实就是先求A->B的最短路径，再求B->C的最短路径，然后拼接一下。

### 如何解决时间相同换乘数最短的问题的

我assume图中任意两个车站之间最短路径的换乘次数都小于100次。这样，我把换乘车站之间的距离（时间）设为0.01，这样时间相同的路线一定整数部分相同，而换乘少的路线的小数部分一定比较小。因此不管用dijkstra 算法还是用floyd算法，只要将最后的时间向下取整，就能得到正确的结果。

如果后续随着图的扩展，存在两个车站之间最短的换乘次数大于等于100次，只要把换乘车站之间的距离设置为0.001，就仍然能保持正确的结果。依次类推即可。

### 其他

之前的程序存在一个bug。bug是由3号线和4号线并线引起的。

例如，输入

```
镇坪路	国权路
```

之前程序给出的路径是

```
镇坪路-line3-宝山路-line4-海伦路-line10-国权路，换乘次数2，所用时间19分钟
```

而由题意，正确的结果是

```
镇坪路-line4-海伦路-国权路，换乘次数1，所用时间19分钟
```

这是由于之前的程序当用户输入一个换乘车站时，程序会将其转换成线路编号较小的线路的车站代码。比如输入“镇坪路”，程序懒惰地会给出68（镇坪路3的车站代码）。这导致了问题的产生。

之后我将程序的行为修改成了给出[68,107]的list（镇坪路3的车站代码和镇坪路4的车站代码）。对终点站也进行了同样的处理。随后将可能的终点站和起点站进行排列组合，计算多条路径，最后选出换乘数小的来解决这个问题。但是这样程序的运行时间由原来的0.5s变长到了1s左右......

# 优化

对于dijkstra算法本身没有特别的优化。

主要的优化（其实不知道这能否算是优化）是，声明一个数组GeneralPath\[][][][] shortesPathSave的数组用来存储最短路径。每次使用dijkstra算法计算完从一个点出发的最短路径后，就将其保存（例如计算完从节点0出发的最短路径，就保存到shortesPathSave[0]中）。下一次再需要计算的时候先检查是否有计算过从这个节点出发的最短路径，如果有则直接取出；如果没有再进行计算并保存。这是一种空间换时间的方法，经尝试，在使用performance-benchmark.txt测试时，优化后的时间是优化前的十分之一（优化前做了很多重复的事情，速度慢，但比较节约内存，优化后对一个节点出发的最短路径只计算一次，但比较费内存）

```
//如果已经对起点A使用过迪杰特斯拉算法了
                if (shortestPathSave[stationNumberA][0] != null) {

                    targetGeneralPathList.add(shortestPathSave[stationNumberA][stationNumberB]);

                } else {//如果对起点A没有进行过迪杰特斯拉算法，则需要计算一遍

                    GeneralPath[] pathsFromA = graph.shortestPath(stationNumberA);

                    //得到目标的那条路
                    GeneralPath path = pathsFromA[stationNumberB];

                    if (path.route == null) {
                        continue;
                    }

                    targetGeneralPathList.add(path);

                    shortestPathSave[stationNumberA] = pathsFromA;

                }
```

